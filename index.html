<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RR Creations</title>
    <link rel="icon" href="https://placehold.co/64x64/4f46e5/ffffff?text=RR" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1a202c, #2d3748);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        /* Glassmorphism Card Style */
        .glass-card {
            background: rgba(45, 55, 72, 0.4);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .btn-gradient {
            background-image: linear-gradient(to right, #6366F1, #8B5CF6);
            transition: all 0.3s ease;
        }
        .btn-gradient:hover {
            box-shadow: 0 0 20px rgba(139, 92, 246, 0.4); /* Reduced glow */
            transform: translateY(-2px);
        }

        .form-input {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.2s ease;
        }

        .form-input:focus {
            background-color: rgba(255, 255, 255, 0.1);
            border-color: #8B5CF6;
            box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3); /* Reduced glow */
        }

        .status-pending {
            border-left: 4px solid #FBBF24;
        }
        .status-received {
            border-left: 4px solid #34D399;
        }
        
        /* Modal Styles */
        .modal-content {
            background: linear-gradient(135deg, #2d3748, #1a202c);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 1.25em 1.25em;
        }

        .active-filter {
            background-color: #6366f1;
            color: white;
            font-weight: 600;
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: #2DD4BF; /* Theme color */
            color: #111827; /* Dark text */
            padding: 1rem 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            z-index: 2000;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease-out, fadeOut 0.3s ease-in 2.7s;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: translateX(0); }
            to { opacity: 0; transform: translateX(100%); }
        }


        /* Print Styles */
        @media print {
            body { background: white; }
            .no-print, #order-form, #install-container, .order-actions { display: none !important; }
            #app { max-width: 100%; padding: 1rem; }
            .print-header { display: block !important; }
            .glass-card { background: transparent !important; box-shadow: none !important; border: 1px solid #e5e7eb !important; }
            h1, h2, h3, p, span { color: #111827 !important; }
        }
    </style>
     <!-- PWA Manifest Link -->
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;RR Creations&quot;,
        &quot;short_name&quot;: &quot;RR Creations&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#1a202c&quot;,
        &quot;theme_color&quot;: &quot;#6366F1&quot;,
        &quot;description&quot;: &quot;A bookkeeper app for RR Creations.&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;https://placehold.co/192x192/6366F1/ffffff?text=RR&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/png&quot; },
            { &quot;src&quot;: &quot;https://placehold.co/512x512/6366F1/ffffff?text=RR&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/png&quot; }
        ]
    }">
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app" class="max-w-xl mx-auto p-4 md:p-6">
        <!-- Header for UI -->
        <header class="text-center mb-8 relative no-print fade-in">
            <h1 class="text-4xl md:text-5xl font-bold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">RR Creations</h1>
            <p class="text-slate-400 mt-2">Your Modern Reselling Bookkeeper</p>
            <div class="absolute top-0 right-0 flex items-center gap-2">
                <button id="test-notification-btn" title="Send a test notification" class="p-2 text-slate-400 hover:text-teal-300 transition-colors">
                    <i data-feather="send"></i>
                </button>
                <button id="notification-btn" title="Enable daily reminders" class="p-2 text-slate-400 hover:text-indigo-400 transition-colors">
                    <i data-feather="bell"></i>
                </button>
            </div>
        </header>

         <!-- Header for Printing -->
         <div class="print-header hidden">
            <h1 id="print-title">RR Creations</h1>
            <p id="print-date"></p>
        </div>


        <!-- Totals Summary -->
        <div class="grid grid-cols-2 gap-4 mb-8 fade-in" style="animation-delay: 0.1s;">
            <div class="glass-card p-4 text-center">
                <h2 class="text-sm font-semibold text-yellow-300 flex items-center justify-center gap-2"><i data-feather="clock" class="w-4 h-4"></i>Pending Profit</h2>
                <p id="total-pending" class="text-3xl font-bold text-yellow-200 mt-2">₹0.00</p>
            </div>
            <div class="glass-card p-4 text-center">
                <h2 class="text-sm font-semibold text-green-300 flex items-center justify-center gap-2"><i data-feather="check-circle" class="w-4 h-4"></i>Received Profit</h2>
                <p id="total-received" class="text-3xl font-bold text-green-200 mt-2">₹0.00</p>
            </div>
        </div>
        
        <!-- Add Order Form -->
        <div class="glass-card p-6 mb-8 fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-2xl font-bold mb-4 text-center">Add a New Order</h2>
            <form id="order-form" class="space-y-4">
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-slate-300">Customer Name</label>
                        <input type="text" id="customer-name" placeholder="e.g., Anjali Sharma" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white" required>
                    </div>
                     <div>
                        <label for="item-description" class="block text-sm font-medium text-slate-300">Item Description</label>
                        <input type="text" id="item-description" placeholder="e.g., Blue Kurti" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white" required>
                    </div>
                </div>

                <div>
                    <label for="vendor-select" class="block text-sm font-medium text-slate-300">Vendor Name</label>
                    <select id="vendor-select" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white">
                        <option value="">Select Vendor</option>
                        <option value="Dilkush">Dilkush</option>
                        <option value="Shubham">Shubham</option>
                        <option value="Shubhi">Shubhi</option>
                        <option value="Others">Others</option>
                    </select>
                </div>

                <div id="other-vendor-container" class="hidden">
                    <label for="vendor-name-other" class="block text-sm font-medium text-slate-300">Other Vendor Name</label>
                    <input type="text" id="vendor-name-other" placeholder="Enter Vendor Name" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="cost-price" class="block text-sm font-medium text-slate-300">Cost Price (₹)</label>
                        <input type="number" id="cost-price" placeholder="e.g., 900" min="0" step="0.01" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white" required>
                    </div>
                    <div>
                        <label for="selling-price" class="block text-sm font-medium text-slate-300">Selling Price (₹)</label>
                        <input type="number" id="selling-price" placeholder="e.g., 1200" min="0" step="0.01" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white" required>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label for="discount" class="block text-sm font-medium text-slate-300">Vendor Discount (₹)</label>
                        <input type="number" id="discount" placeholder="0" min="0" step="0.01" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white">
                    </div>
                    <div>
                        <label for="payment-method" class="block text-sm font-medium text-slate-300">Payment Method</label>
                        <select id="payment-method" class="form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white" required>
                            <option value="GPay">GPay</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>

                <button id="add-order-btn" type="submit" class="w-full btn-gradient text-white font-semibold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-slate-900 focus:ring-indigo-500">Add Order</button>
            </form>
        </div>

        <!-- Monthly Recap -->
        <div id="recap-container" class="glass-card p-6 mb-8 fade-in" style="animation-delay: 0.3s;">
             <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold">Monthly Recap</h2>
                 <div class="no-print flex items-center">
                     <button id="share-report" title="Share Report" class="p-2 text-slate-400 hover:text-indigo-400 transition-colors">
                        <i data-feather="share-2"></i>
                     </button>
                     <button id="export-pdf" title="Export as PDF" class="p-2 text-slate-400 hover:text-indigo-400 transition-colors">
                        <i data-feather="printer"></i>
                     </button>
                 </div>
            </div>
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label for="month-select" class="block text-sm font-medium text-slate-300">Month</label>
                    <select id="month-select" class="month-select form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white"></select>
                </div>
                <div class="flex-1">
                    <label for="year-select" class="block text-sm font-medium text-slate-300">Year</label>
                    <select id="year-select" class="year-select form-input mt-1 block w-full px-3 py-2 rounded-md text-sm shadow-sm text-white"></select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <h3 class="text-sm font-semibold text-slate-400">Total Sales</h3>
                    <p id="monthly-sales" class="text-lg font-bold text-blue-400">₹0.00</p>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-slate-400">Total Costs</h3>
                    <p id="monthly-costs" class="text-lg font-bold text-red-400">₹0.00</p>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-slate-400">Received Profit</h3>
                    <p id="monthly-profit" class="text-lg font-bold text-green-400">₹0.00</p>
                </div>
                 <div>
                    <h3 class="text-sm font-semibold text-slate-400">Pending Profit</h3>
                    <p id="monthly-pending" class="text-lg font-bold text-yellow-400">₹0.00</p>
                </div>
            </div>
        </div>

        <!-- Install Button -->
        <div id="install-container" class="text-center mb-6" style="display: none;">
            <button id="install-button" class="btn-gradient text-white font-semibold py-2 px-6 rounded-lg">
                Install App
            </button>
        </div>

        <!-- Order List -->
        <div class="fade-in" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between mb-4">
                 <h2 class="text-2xl font-bold">Order History</h2>
                 <div id="filter-container" class="flex border border-slate-600 rounded-lg p-0.5 bg-slate-700/50 no-print">
                    <button data-filter="all" class="filter-btn active-filter text-sm px-3 py-1 rounded-md">All</button>
                    <button data-filter="pending" class="filter-btn text-sm px-3 py-1 rounded-md">Pending</button>
                    <button data-filter="received" class="filter-btn text-sm px-3 py-1 rounded-md">Received</button>
                    <button data-filter="archived" class="filter-btn text-sm px-3 py-1 rounded-md">Archived</button>
                 </div>
            </div>
            <div id="order-list" class="space-y-4">
                <p id="no-orders" class="text-center text-slate-400 py-8">No orders yet. Add one to get started!</p>
            </div>
        </div>

        <footer class="text-center text-slate-500 text-sm mt-10 pb-6 no-print">
            <p>&copy; <span id="copyright-year"></span> Rangriti Creations, Mumbai. All Rights Reserved.</p>
        </footer>
    </div>

    <!-- Action Modal -->
    <div id="action-modal" class="modal-backdrop no-print">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg text-center font-bold mb-4"></h3>
            <div id="modal-body"></div>
            <div id="modal-footer" class="flex justify-center gap-4 mt-8"></div>
        </div>
    </div>


    <script>
        // --- App State & Elements ---
        const { jsPDF } = window.jspdf;
        const STORAGE_KEY = 'rr-creations-orders';

        let allOrders = []; // Local cache of all orders
        let itemToModifyId = null;
        let currentModifyAction = null;
        let currentFilter = 'all'; 

        const orderForm = document.getElementById('order-form');
        const customerNameInput = document.getElementById('customer-name');
        const itemDescriptionInput = document.getElementById('item-description');
        const vendorSelect = document.getElementById('vendor-select');
        const otherVendorContainer = document.getElementById('other-vendor-container');
        const vendorNameOtherInput = document.getElementById('vendor-name-other');
        const costPriceInput = document.getElementById('cost-price');
        const sellingPriceInput = document.getElementById('selling-price');
        const paymentMethodInput = document.getElementById('payment-method');
        const discountInput = document.getElementById('discount');
        const orderList = document.getElementById('order-list');
        const totalPendingEl = document.getElementById('total-pending');
        const totalReceivedEl = document.getElementById('total-received');
        const noOrdersEl = document.getElementById('no-orders');
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const monthlySalesEl = document.getElementById('monthly-sales');
        const monthlyCostsEl = document.getElementById('monthly-costs');
        const monthlyProfitEl = document.getElementById('monthly-profit');
        const monthlyPendingEl = document.getElementById('monthly-pending');
        const addOrderBtn = document.getElementById('add-order-btn');
        
        const actionModal = document.getElementById('action-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalFooter = document.getElementById('modal-footer');

        const notificationBtn = document.getElementById('notification-btn');
        const testNotificationBtn = document.getElementById('test-notification-btn');
        const filterContainer = document.getElementById('filter-container');
        const exportPdfBtn = document.getElementById('export-pdf');
        const shareReportBtn = document.getElementById('share-report');
        const printDateEl = document.getElementById('print-date');
        const printTitleEl = document.getElementById('print-title');

        const presetDiscounts = {
            'Dilkush': 100,
            'Shubham': 75,
            'Shubhi': 30
        };

        // --- Helper Functions ---
        const formatCurrency = (num) => {
            if (typeof num !== 'number') num = 0;
            return num.toLocaleString('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };
        
        const showToast = (message) => {
            // Remove any existing toast
            const existingToast = document.querySelector('.toast');
            if (existingToast) {
                existingToast.remove();
            }

            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i data-feather="check-circle" class="w-5 h-5"></i>
                <span class="font-semibold">${message}</span>
            `;
            document.body.appendChild(toast);
            if(typeof feather !== 'undefined') feather.replace();

            setTimeout(() => {
                toast.remove();
            }, 3000); // Remove after 3 seconds
        };

        // --- Data Functions (localStorage) ---
        const loadOrders = () => {
            try {
                const ordersJson = localStorage.getItem(STORAGE_KEY);
                if (ordersJson) {
                    allOrders = JSON.parse(ordersJson);
                    // Ensure dates are numbers for sorting
                    allOrders.forEach(o => { o.createdAt = Number(o.createdAt) });
                    allOrders.sort((a, b) => b.createdAt - a.createdAt);
                } else {
                    allOrders = [];
                }
            } catch(e) {
                console.error("Error loading orders from localStorage", e);
                allOrders = [];
            }
        };

        const saveOrders = () => {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(allOrders));
            } catch(e) {
                console.error("Error saving orders to localStorage", e);
                showMessageModal('Save Error', 'Could not save data to your device. Your device storage might be full.');
            }
            // After saving, re-render everything
            renderOrders();
            updateTotals();
            calculateMonthlyRecap();
        };

        // --- Core Functions ---
        const addOrder = (e) => {
            e.preventDefault();
            
            const customerName = customerNameInput.value.trim();
            const selectedVendor = vendorSelect.value;
            const vendorName = selectedVendor === 'Others' ? vendorNameOtherInput.value.trim() : selectedVendor;
            const itemDescription = itemDescriptionInput.value.trim();
            
            const costPriceValue = costPriceInput.value.replace(/,/g, '');
            const sellingPriceValue = sellingPriceInput.value.replace(/,/g, '');
            const discountValue = discountInput.value.replace(/,/g, '');

            const costPrice = parseFloat(costPriceValue);
            const sellingPrice = parseFloat(sellingPriceValue);
            const discount = parseFloat(discountValue) || 0;
            const finalCostPrice = costPrice - discount;

            const paymentMethod = paymentMethodInput.value;

            // --- Improved Validation ---
             if (!customerName) {
                showMessageModal('Missing Customer', 'Please enter a customer name.');
                return;
            }
            if (!vendorName) {
                showMessageModal('Missing Vendor', 'Please select or enter a vendor name.');
                return;
            }
            if (!itemDescription) {
                showMessageModal('Missing Information', 'Please enter an item description.');
                return;
            }
            if (isNaN(costPrice) || isNaN(sellingPrice) || costPrice < 0 || sellingPrice < 0) {
                showMessageModal('Invalid Price', 'Please enter valid numbers for the cost and selling price.');
                return;
            }
            if (sellingPrice < finalCostPrice) {
                showMessageModal('Invalid Pricing', 'The selling price cannot be less than the final cost (after discount).');
                return;
            }

            const profit = sellingPrice - finalCostPrice;
            
            const newOrder = {
                id: crypto.randomUUID(),
                customerName,
                itemDescription,
                vendorName,
                costPrice,
                sellingPrice,
                discount,
                finalCostPrice,
                profit,
                paymentMethod,
                status: 'pending',
                createdAt: Date.now(),
                isArchived: false
            };

            allOrders.unshift(newOrder);
            saveOrders();
            orderForm.reset();
            showToast('Order added successfully!');
            // Reset vendor dropdown specific fields
            vendorSelect.value = '';
            otherVendorContainer.classList.add('hidden');
            vendorNameOtherInput.required = false;
            discountInput.readOnly = false;
        };
        
        const updateStatus = (id, newStatus) => {
            const orderIndex = allOrders.findIndex(o => o.id === id);
            if (orderIndex > -1) {
                allOrders[orderIndex].status = newStatus;
                saveOrders();
            }
        };

        const archiveOrder = (id) => {
            const orderIndex = allOrders.findIndex(o => o.id === id);
            if (orderIndex > -1) {
                allOrders[orderIndex].isArchived = true;
                saveOrders();
            }
        };
        
        const unarchiveOrder = (id) => {
            const orderIndex = allOrders.findIndex(o => o.id === id);
            if (orderIndex > -1) {
                allOrders[orderIndex].isArchived = false;
                saveOrders();
            }
        };

        const deleteOrder = (id) => {
            allOrders = allOrders.filter(o => o.id !== id);
            saveOrders();
        };
        
        // --- Modal Functions ---
        const hideActionModal = () => {
            actionModal.style.display = 'none';
            modalBody.innerHTML = '';
            modalFooter.innerHTML = '';
        };

        const showConfirmationModal = (id, action) => {
            itemToModifyId = id;
            currentModifyAction = action;

            let title, text, confirmText, confirmClass;
            if (action === 'archive') {
                title = 'Confirm Archive';
                text = 'Are you sure you want to archive this order? You can view it later in the "Archived" section.';
                confirmText = 'Archive';
                confirmClass = 'bg-slate-500 text-white hover:bg-slate-600';
            } else if (action === 'delete') {
                title = 'Confirm Deletion';
                text = 'Are you sure you want to permanently delete this order? This action cannot be undone.';
                confirmText = 'Delete';
                confirmClass = 'bg-red-600 text-white hover:bg-red-700';
            }

            modalTitle.textContent = title;
            modalBody.innerHTML = `<p class="text-slate-300 text-center">${text}</p>`;
            modalFooter.innerHTML = `
                <button id="confirm-btn" class="${confirmClass} font-semibold py-2 px-6 rounded-lg">${confirmText}</button>
                <button id="cancel-btn" class="bg-slate-600 text-slate-200 font-semibold py-2 px-6 rounded-lg hover:bg-slate-500">Cancel</button>
            `;

            document.getElementById('confirm-btn').onclick = handleConfirm;
            document.getElementById('cancel-btn').onclick = hideActionModal;
            actionModal.style.display = 'flex';
        };

        const showMessageModal = (title, text) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p class="text-slate-300 text-center">${text}</p>`;
            modalFooter.innerHTML = `<button id="ok-btn" class="w-full btn-gradient text-white font-semibold py-2 px-4 rounded-lg">OK</button>`;
            
            document.getElementById('ok-btn').onclick = hideActionModal;
            actionModal.style.display = 'flex';
        }

        const handleConfirm = () => {
            if (!itemToModifyId || !currentModifyAction) return;
            
            if (currentModifyAction === 'archive') {
                archiveOrder(itemToModifyId);
            } else if (currentModifyAction === 'delete') {
                deleteOrder(itemToModifyId);
            }
            hideActionModal();
        };
        
        const calculateMonthlyRecap = () => {
            const selectedMonth = parseInt(monthSelect.value);
            const selectedYear = parseInt(yearSelect.value);

            const filteredOrders = allOrders.filter(order => {
                if (order.isArchived || !order.createdAt) return false;
                const orderDate = new Date(order.createdAt);
                return orderDate.getMonth() === selectedMonth && orderDate.getFullYear() === selectedYear;
            });
            
            const sales = filteredOrders.reduce((sum, o) => sum + o.sellingPrice, 0);
            const costs = filteredOrders.reduce((sum, o) => sum + (o.finalCostPrice ?? o.costPrice), 0);
            const receivedProfit = filteredOrders.filter(o => o.status === 'received').reduce((sum, o) => sum + o.profit, 0);
            const pendingProfit = filteredOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);

            monthlySalesEl.textContent = formatCurrency(sales);
            monthlyCostsEl.textContent = formatCurrency(costs);
            monthlyProfitEl.textContent = formatCurrency(receivedProfit);
            monthlyPendingEl.textContent = formatCurrency(pendingProfit);
        };

        // --- UI Rendering ---
        const renderOrders = () => {
            orderList.innerHTML = '';
            
            const filteredOrders = allOrders.filter(order => {
                if (currentFilter === 'archived') {
                    return order.isArchived;
                }
                if (order.isArchived) return false;
                if (currentFilter === 'all') return true;
                return order.status === currentFilter;
            });
            
            const noOrdersEl = document.getElementById('no-orders');
            if (filteredOrders.length > 0) {
                 if(noOrdersEl) {
                    noOrdersEl.style.display = 'none';
                 }
            } else {
                if(noOrdersEl) {
                    noOrdersEl.style.display = 'block';
                } else {
                     const noOrdersCard = document.createElement('div');
                     noOrdersCard.id = "no-orders";
                     noOrdersCard.className = "glass-card text-center text-slate-400 p-12 rounded-2xl";
                     noOrdersCard.innerHTML = `
                        <h3 class="text-xl font-semibold text-white">Ready for your first order?</h3>
                        <p class="mt-2">Fill out the form above to get started!</p>`;
                    orderList.appendChild(noOrdersCard);
                }
            }
            
            filteredOrders.forEach(order => {
                const isPending = order.status === 'pending';
                const cardClass = isPending ? 'status-pending' : 'status-received';
                const statusTextClass = isPending ? 'text-yellow-300' : 'text-green-300';

                const orderEl = document.createElement('div');
                orderEl.className = `glass-card p-6 flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 ${cardClass} fade-in`;
                orderEl.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-bold text-lg text-slate-100">${order.customerName}</p>
                        <p class="text-sm text-slate-300">${order.itemDescription}</p>
                        ${order.vendorName ? `<p class="text-xs text-slate-400 mt-1">From: <span class="font-medium">${order.vendorName}</span></p>` : ''}
                        <div class="mt-4 border-t border-slate-700 pt-4 flex flex-wrap items-center gap-x-4 gap-y-2 text-sm">
                           <span class="flex items-center gap-1" title="Selling Price"><i data-feather="tag" class="w-4 h-4 text-slate-400"></i> ${formatCurrency(order.sellingPrice)}</span>
                           <span class="flex items-center gap-1" title="Cost Price"><i data-feather="shopping-cart" class="w-4 h-4 text-slate-400"></i> ${formatCurrency(order.costPrice)}</span>
                           ${order.discount > 0 ? `<span class="flex items-center gap-1 text-red-400" title="Discount"><i data-feather="percent" class="w-4 h-4"></i> - ${formatCurrency(order.discount)}</span>` : ''}
                           ${order.discount > 0 ? `<span class="flex items-center gap-1 font-bold" title="Final Cost"><i data-feather="shield" class="w-4 h-4 text-slate-400"></i> ${formatCurrency(order.finalCostPrice)}</span>` : ''}
                           <span class="flex items-center gap-1 font-bold text-green-400 text-base" title="Profit"><i data-feather="dollar-sign" class="w-4 h-4"></i> ${formatCurrency(order.profit)}</span>
                        </div>
                    </div>
                    <div class="flex flex-col sm:items-end gap-3 w-full sm:w-auto flex-shrink-0 order-actions">
                         <span class="font-bold text-sm uppercase ${statusTextClass} tracking-wider">${order.status}</span>
                         <div class="flex items-center gap-2 w-full sm:w-auto">
                            ${order.isArchived ? 
                                `<button data-id="${order.id}" data-action="unarchive" class="bg-sky-500/80 hover:bg-sky-500 text-white flex-grow sm:flex-grow-0 text-sm font-semibold py-2 px-3 rounded-md transition">Unarchive</button>
                                 <button data-id="${order.id}" data-action="delete" class="bg-red-500/80 hover:bg-red-500 text-white p-2 rounded-md transition" title="Delete Permanently">
                                    <i data-feather="trash-2" class="w-4 h-4"></i>
                                 </button>`
                            :
                            isPending ? 
                            `<button data-id="${order.id}" data-action="receive" class="bg-green-500/80 hover:bg-green-500 text-white flex-grow sm:flex-grow-0 text-sm font-semibold py-2 px-3 rounded-md transition">Received</button>` : 
                            `<button data-id="${order.id}" data-action="pend" class="bg-yellow-500/80 hover:bg-yellow-500 text-white flex-grow sm:flex-grow-0 text-sm font-semibold py-2 px-3 rounded-md transition">Pending</button>`
                            }
                            ${!order.isArchived ? `<button data-id="${order.id}" data-action="archive" class="bg-slate-500/80 hover:bg-slate-500 text-white p-2 rounded-md transition" title="Archive">
                                 <i data-feather="archive" class="w-4 h-4"></i>
                            </button>` : ''}
                        </div>
                    </div>
                `;
                orderList.appendChild(orderEl);
            });
            if (typeof feather !== 'undefined') {
                feather.replace();
            }
        };

        const updateTotals = () => {
            const activeOrders = allOrders.filter(o => !o.isArchived);
            const pendingProfit = activeOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);
            const receivedProfit = activeOrders.filter(o => o.status === 'received').reduce((sum, o) => sum + o.profit, 0);

            totalPendingEl.textContent = formatCurrency(pendingProfit);
            totalReceivedEl.textContent = formatCurrency(receivedProfit);
        };
        
        function setupDateSelectors(container, currentMonth, currentYear) {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            const monthSelectEl = container.querySelector('.month-select');
            const yearSelectEl = container.querySelector('.year-select');

            if (!monthSelectEl || !yearSelectEl) {
                console.error("Could not find month or year select elements in the provided container.", container);
                return;
            }

            monthSelectEl.innerHTML = '';
            yearSelectEl.innerHTML = '';

            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                if (index === currentMonth) option.selected = true;
                monthSelectEl.appendChild(option);
            });
            
            const uniqueYears = [...new Set(allOrders.map(o => o.createdAt ? new Date(o.createdAt).getFullYear() : currentYear))];
            if (!uniqueYears.includes(currentYear)) uniqueYears.push(currentYear);
            uniqueYears.sort((a,b) => b - a);

            uniqueYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelectEl.appendChild(option);
            });
        }

        // --- Notification Logic ---
        function sendTestNotification() {
            if (!('Notification' in window)) {
                showMessageModal('Not Supported', 'Sorry, your browser does not support notifications.');
                return;
            }

            if (Notification.permission === 'granted') {
                const title = 'Test Notification';
                const options = {
                    body: 'This is a sample reminder from RR Creations!',
                    icon: 'https://placehold.co/192x192/4f46e5/ffffff?text=RR',
                    tag: 'test-notification'
                };
                new Notification(title, options);
            } else {
                handleNotificationBellClick(); // Guide user through permissions
            }
        }

        const handleNotificationBellClick = () => {
            if (!('Notification' in window)) {
                showMessageModal('Not Supported', 'Sorry, your browser does not support notifications.');
                return;
            }

            const permission = Notification.permission;

            if (permission === 'granted') {
                showMessageModal('Notifications Active', 'Reminders are already enabled. You will be notified of pending payments after 11 PM.');
            } else if (permission === 'denied') {
                showMessageModal('Notifications Blocked', 'You have blocked notifications. To receive reminders, please enable them in your browser or system settings.');
            } else { // permission is 'default'
                Notification.requestPermission().then(newPermission => {
                    if (newPermission === 'granted') {
                        showMessageModal('Notifications Enabled', 'You will now receive reminders for pending payments after 11 PM.');
                        setInterval(checkTimeForReminder, 60 * 1000); // Start the checker
                    } else {
                        showMessageModal('Permission Not Granted', 'You have chosen not to receive notifications.');
                    }
                    updateNotificationBellUI();
                });
            }
        };

        function updateNotificationBellUI() {
            const bellSVG = notificationBtn.querySelector('svg');
            if (!('Notification' in window)) {
                bellSVG.style.stroke = '#9ca3af'; // gray-400
                notificationBtn.style.opacity = '0.5';
                notificationBtn.style.cursor = 'not-allowed';
                return;
            }

            switch(Notification.permission) {
                case "granted":
                    bellSVG.style.stroke = '#2DD4BF'; // Theme accent color
                    break;
                case "denied":
                    bellSVG.style.stroke = '#F87171'; // red-400
                    notificationBtn.style.opacity = '0.6';
                    notificationBtn.style.cursor = 'not-allowed';
                    break;
                default:
                    bellSVG.style.stroke = 'currentColor'; // default
            }
        }

        function setupReminder() {
            updateNotificationBellUI();

            if (!('Notification' in window) || Notification.permission === "denied") return;
            if (Notification.permission === "granted") setInterval(checkTimeForReminder, 60 * 1000);

            notificationBtn.addEventListener('click', handleNotificationBellClick);
        }

        function checkTimeForReminder() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const lastNotificationDate = localStorage.getItem('lastNotificationDate');
            
            if (now.getHours() >= 23 && lastNotificationDate !== todayStr) {
                const activeOrders = allOrders.filter(o => !o.isArchived);
                const totalPending = activeOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);
                
                if (totalPending > 0) {
                     const title = 'Daily Profit Reminder';
                     const options = {
                        body: `You have ${formatCurrency(totalPending)} in pending profit. Don't forget to follow up!`,
                        icon: 'https://placehold.co/192x192/4f46e5/ffffff?text=RR',
                        tag: 'profit-reminder', 
                        renotify: true,
                     };
                     new Notification(title, options);
                     localStorage.setItem('lastNotificationDate', todayStr);
                }
            }
        }
        
        // --- Share & Export ---
        const handleShareClick = () => {
            modalTitle.textContent = 'Generate & Share Report';
            modalBody.innerHTML = `
                <p class="text-slate-300 text-center mb-4">Select the month and year for the report you want to share.</p>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label for="share-month-select" class="block text-sm font-medium text-slate-300">Month</label>
                        <select id="share-month-select" class="month-select form-input mt-1 block w-full px-3 py-2 text-white"></select>
                    </div>
                    <div class="flex-1">
                        <label for="share-year-select" class="block text-sm font-medium text-slate-300">Year</label>
                        <select id="share-year-select" class="year-select form-input mt-1 block w-full px-3 py-2 text-white"></select>
                    </div>
                </div>`;
            
            const now = new Date();
            setupDateSelectors(modalBody, now.getMonth(), now.getFullYear());

            modalFooter.innerHTML = `
                <button id="generate-share-btn" class="w-full btn-gradient text-white font-semibold py-2 px-4 rounded-lg">Generate & Share PDF</button>
            `;

            document.getElementById('generate-share-btn').onclick = generateAndSharePdf;
            actionModal.style.display = 'flex';
        };

        const generateAndSharePdf = async () => {
            const shareMonthSelect = document.getElementById('share-month-select');
            const shareYearSelect = document.getElementById('share-year-select');
            
            const month = parseInt(shareMonthSelect.value);
            const year = parseInt(shareYearSelect.value);
            const monthName = shareMonthSelect.options[shareMonthSelect.selectedIndex].text;
            
            hideActionModal();
            showMessageModal('Generating PDF...', 'Please wait while your report is being created. The share dialog will appear shortly.');
            
            const doc = new jsPDF();
            
            const filteredOrders = allOrders.filter(order => {
                if (order.isArchived || !order.createdAt) return false;
                const orderDate = new Date(order.createdAt);
                return orderDate.getMonth() === month && orderDate.getFullYear() === year;
            });

            if (filteredOrders.length === 0) {
                 showMessageModal('No Data', `There are no orders for ${monthName} ${year} to generate a report.`);
                 return;
            }

            const head = [['Date', 'Customer', 'Item', 'Vendor', 'Sale', 'Cost', 'Discount', 'Final Cost', 'Profit', 'Status']];
            const body = filteredOrders.map(o => [
                new Date(o.createdAt).toLocaleDateString(),
                o.customerName,
                o.itemDescription,
                o.vendorName,
                formatCurrency(o.sellingPrice),
                formatCurrency(o.costPrice),
                formatCurrency(o.discount || 0),
                formatCurrency(o.finalCostPrice ?? o.costPrice),
                formatCurrency(o.profit),
                o.status
            ]);
            
            const sales = filteredOrders.reduce((sum, o) => sum + o.sellingPrice, 0);
            const costs = filteredOrders.reduce((sum, o) => sum + (o.finalCostPrice ?? o.costPrice), 0);
            const receivedProfit = filteredOrders.filter(o => o.status === 'received').reduce((sum, o) => sum + o.profit, 0);
            const pendingProfit = filteredOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);
            
            doc.setFontSize(18);
            doc.text(`RR Creations - Report for ${monthName} ${year}`, 14, 20);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 26);
            
            doc.autoTable({
                startY: 30,
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });
            
            const summaryY = doc.autoTable.previous.finalY + 10;
            doc.setFontSize(12);
            doc.text('Monthly Summary', 14, summaryY);
            doc.autoTable({
                startY: summaryY + 4,
                body: [
                    ['Total Sales', formatCurrency(sales)],
                    ['Total Final Costs', formatCurrency(costs)],
                    ['Pending Profit', formatCurrency(pendingProfit)],
                    ['Received Profit', formatCurrency(receivedProfit)],
                ],
                theme: 'grid',
                columnStyles: { 0: { fontStyle: 'bold' } }
            });

            const pdfBlob = doc.output('blob');
            const fileName = `RR_Creations_Report_${monthName}_${year}.pdf`;
            const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

            if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                try {
                    await navigator.share({
                        title: `RR Creations Report for ${monthName} ${year}`,
                        text: `Here is the monthly report for ${monthName} ${year}.`,
                        files: [pdfFile]
                    });
                    hideActionModal();
                } catch (error) {
                    console.error('Share failed:', error);
                    showMessageModal('Share Failed', 'There was an error trying to share the file. Please try exporting instead.');
                }
            } else {
                showMessageModal('Share Not Supported', 'Your browser does not support sharing files. Please use the "Export PDF" button to download the report.');
            }
        };

        // --- Event Listeners ---
        vendorSelect.addEventListener('change', (e) => {
            const selectedVendor = e.target.value;
            if (selectedVendor === 'Others') {
                otherVendorContainer.classList.remove('hidden');
                vendorNameOtherInput.required = true;
                discountInput.value = '';
                discountInput.readOnly = false;
                discountInput.placeholder = 'e.g., 50';
            } else if (presetDiscounts[selectedVendor]) {
                otherVendorContainer.classList.add('hidden');
                vendorNameOtherInput.required = false;
                vendorNameOtherInput.value = '';
                discountInput.value = presetDiscounts[selectedVendor];
                discountInput.readOnly = true;
            } else {
                otherVendorContainer.classList.add('hidden');
                vendorNameOtherInput.required = false;
                vendorNameOtherInput.value = '';
                discountInput.value = '';
                discountInput.readOnly = false;
                discountInput.placeholder = '0';
            }
        });

        orderForm.addEventListener('submit', addOrder);
        orderList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { id, action } = button.dataset;
            if (action === 'receive') updateStatus(id, 'received');
            else if (action === 'pend') updateStatus(id, 'pending');
            else if (action === 'archive') showConfirmationModal(id, 'archive');
            else if (action === 'delete') showConfirmationModal(id, 'delete');
            else if (action === 'unarchive') unarchiveOrder(id);
        });

        filterContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            currentFilter = button.dataset.filter;
            filterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter'));
            button.classList.add('active-filter');
            renderOrders();
        });
        
        monthSelect.addEventListener('change', calculateMonthlyRecap);
        yearSelect.addEventListener('change', calculateMonthlyRecap);
        actionModal.addEventListener('click', (e) => {
            if (e.target === actionModal) hideActionModal();
        });

        exportPdfBtn.addEventListener('click', () => {
            const selectedMonth = monthSelect.options[monthSelect.selectedIndex].text;
            const selectedYear = yearSelect.value;
            printTitleEl.textContent = `RR Creations - ${selectedMonth} ${selectedYear} Report`;
            printDateEl.textContent = `Generated on: ${new Date().toLocaleDateString()}`;
            window.print();
        });
        shareReportBtn.addEventListener('click', handleShareClick);
        testNotificationBtn.addEventListener('click', sendTestNotification);


        // --- PWA Install Logic ---
        let deferredPrompt;
        const installContainer = document.getElementById('install-container');
        const installButton = document.getElementById('install-button');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installContainer.style.display = 'block';
        });
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                installContainer.style.display = 'none';
            }
        });
        
        // --- App Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadOrders();

            const now = new Date();
            document.getElementById('copyright-year').textContent = now.getFullYear();
            const recapContainer = document.getElementById('recap-container');
            if (recapContainer) {
                setupDateSelectors(recapContainer, now.getMonth(), now.getFullYear());
            }

            renderOrders();
            updateTotals();
            calculateMonthlyRecap();
            setupReminder();
            if (typeof feather !== 'undefined') {
                feather.replace();
            } else {
                console.error("Feather Icons script not loaded or failed to load.");
            }
        });

    </script>
</body>
</html>



















