<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RR Creations</title>
    <link rel="icon" href="https://placehold.co/64x64/4f46e5/ffffff?text=RR" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.1/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for better UX */
        .status-pending {
            background-color: #FEF9C3; /* yellow-100 */
            border-left: 4px solid #FACC15; /* yellow-400 */
        }
        .dark .status-pending {
             background-color: rgba(250, 204, 21, 0.1);
             border-left-color: #FACC15;
        }
        .text-status-pending {
            color: #CA8A04; /* yellow-600 */
        }
         .dark .text-status-pending {
            color: #FDE047; /* yellow-300 */
        }
        .status-received {
            background-color: #DCFCE7; /* green-100 */
            border-left: 4px solid #4ADE80; /* green-400 */
        }
        .dark .status-received {
             background-color: rgba(74, 222, 128, 0.1);
             border-left-color: #4ADE80;
        }
        .text-status-received {
            color: #16A34A; /* green-600 */
        }
        .dark .text-status-received {
            color: #86EFAC; /* green-300 */
        }
        .btn-pending {
             background-color: #FBBF24;
             color: #78350F;
        }
        .btn-pending:hover {
            background-color: #F59E0B;
        }
        .btn-received {
            background-color: #34D399;
            color: #065F46;
        }
         .btn-received:hover {
            background-color: #10B981;
        }
        /* Simple modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05);
            width: 90%;
            max-width: 400px;
        }
        .dark .modal-content {
            background-color: #1f2937; /* gray-800 */
        }
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1.5em 1.5em;
            padding-right: 2.5rem;
        }
        .dark select {
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%239ca3af' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        .filter-btn {
            transition: all 0.2s ease-in-out;
        }
        .active-filter {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
            font-weight: 600;
        }
        .dark .active-filter {
            background-color: #6366f1; /* indigo-500 */
        }

        /* Print Styles */
        @media print {
            body, #app {
                margin: 0;
                padding: 0;
                background-color: white;
                color: black;
                box-shadow: none;
            }
            .no-print, #order-form, #install-container, .order-actions {
                display: none !important;
            }
            #app {
                 max-width: 100%;
                 padding: 1rem;
            }
            .print-header {
                display: block !important;
                text-align: center;
                margin-bottom: 2rem;
                border-bottom: 2px solid #e5e7eb;
                padding-bottom: 1rem;
            }
            .print-header h1 {
                font-size: 2rem;
                color: #111827;
            }
            .print-header p {
                font-size: 1rem;
                color: #4b5563;
            }
            .bg-white, .dark\:bg-slate-800, .bg-yellow-100, .dark\:bg-yellow-900\/50, .bg-green-100, .dark\:bg-green-900\/50 {
                background: transparent !important;
                box-shadow: none !important;
                border: 1px solid #e5e7eb !important;
            }
            .order-card {
                page-break-inside: avoid;
                border: 1px solid #e5e7eb !important;
            }
            h1, h2, h3, p, span {
                color: #111827 !important;
            }
        }
    </style>
     <!-- PWA Manifest Link -->
    <link rel="manifest" href="data:application/json,{
        &quot;name&quot;: &quot;RR Creations&quot;,
        &quot;short_name&quot;: &quot;RR Creations&quot;,
        &quot;start_url&quot;: &quot;.&quot;,
        &quot;display&quot;: &quot;standalone&quot;,
        &quot;background_color&quot;: &quot;#1e293b&quot;,
        &quot;theme_color&quot;: &quot;#4f46e5&quot;,
        &quot;description&quot;: &quot;A bookkeeper app for RR Creations.&quot;,
        &quot;icons&quot;: [
            { &quot;src&quot;: &quot;https://placehold.co/192x192/4f46e5/ffffff?text=RR&quot;, &quot;sizes&quot;: &quot;192x192&quot;, &quot;type&quot;: &quot;image/png&quot; },
            { &quot;src&quot;: &quot;https://placehold.co/512x512/4f46e5/ffffff?text=RR&quot;, &quot;sizes&quot;: &quot;512x512&quot;, &quot;type&quot;: &quot;image/png&quot; }
        ]
    }">
</head>
<body class="bg-slate-900 text-slate-200">

    <div id="app" class="max-w-xl mx-auto p-4 md:p-6">
        <!-- Header for UI -->
        <header class="text-center mb-6 relative no-print">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-400">RR Creations</h1>
            <p class="text-slate-400 mt-1">Manage your reselling business finances.</p>
            <div class="absolute top-0 right-0 flex items-center gap-2">
                <button id="notification-btn" title="Enable daily reminders" class="p-2 text-slate-400 hover:text-indigo-400">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-bell"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path><path d="M13.73 21a2 2 0 0 1-3.46 0"></path></svg>
                </button>
            </div>
        </header>

         <!-- Header for Printing -->
         <div class="print-header hidden">
            <h1 id="print-title">RR Creations</h1>
            <p id="print-date"></p>
        </div>


        <!-- Totals Summary -->
        <div class="grid grid-cols-2 gap-4 mb-6">
            <div class="bg-yellow-900/50 p-4 rounded-lg shadow-lg border border-yellow-400/20">
                <h2 class="text-sm font-semibold text-yellow-300">Pending Profit</h2>
                <p id="total-pending" class="text-2xl font-bold text-yellow-200">₹0.00</p>
            </div>
            <div class="bg-green-900/50 p-4 rounded-lg shadow-lg border border-green-400/20">
                <h2 class="text-sm font-semibold text-green-300">Received Profit</h2>
                <p id="total-received" class="text-2xl font-bold text-green-200">₹0.00</p>
            </div>
        </div>
        
        <!-- Add Order Form -->
        <div class="bg-slate-800 p-6 rounded-lg shadow-xl mb-6">
            <h2 class="text-xl font-bold mb-4">Add New Order</h2>
            <form id="order-form" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="customer-name" class="block text-sm font-medium text-slate-300">Customer Name</label>
                        <input type="text" id="customer-name" placeholder="e.g., Anjali Sharma" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    </div>
                    <div>
                        <label for="item-description" class="block text-sm font-medium text-slate-300">Item Description</label>
                        <input type="text" id="item-description" placeholder="e.g., Blue Kurti" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    </div>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label for="vendor-name" class="block text-sm font-medium text-slate-300">Vendor Name (Optional)</label>
                        <input type="text" id="vendor-name" placeholder="e.g., Surat Textiles" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white">
                    </div>
                    <div>
                        <label for="payment-method" class="block text-sm font-medium text-slate-300">Payment Method</label>
                        <select id="payment-method" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                            <option value="GPay">GPay</option>
                            <option value="Cash">Cash</option>
                        </select>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label for="cost-price" class="block text-sm font-medium text-slate-300">Cost Price (₹)</label>
                        <input type="number" id="cost-price" placeholder="e.g., 900" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    </div>
                    <div>
                        <label for="selling-price" class="block text-sm font-medium text-slate-300">Selling Price (₹)</label>
                        <input type="number" id="selling-price" placeholder="e.g., 1200" min="0" step="0.01" class="mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm placeholder-slate-400 focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white" required>
                    </div>
                </div>
                <button type="submit" class="w-full bg-indigo-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-400 transition-colors duration-200">Add Order</button>
            </form>
        </div>

        <!-- Monthly Recap -->
        <div id="recap-container" class="bg-slate-800 p-6 rounded-lg shadow-xl mb-6">
            <div class="flex justify-between items-start">
                <h2 class="text-xl font-bold mb-4">Monthly Recap</h2>
                 <div class="no-print -mt-2 flex items-center">
                     <button id="share-report" title="Share Report" class="p-2 text-slate-400 hover:text-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-share-2"><circle cx="18" cy="5" r="3"></circle><circle cx="6" cy="12" r="3"></circle><circle cx="18" cy="19" r="3"></circle><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"></line><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"></line></svg>
                     </button>
                     <button id="export-pdf" title="Export as PDF" class="p-2 text-slate-400 hover:text-indigo-400">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-printer"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                     </button>
                 </div>
            </div>
            <div class="flex gap-4 mb-4">
                <div class="flex-1">
                    <label for="month-select" class="block text-sm font-medium text-slate-300">Month</label>
                    <select id="month-select" class="month-select mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                </div>
                <div class="flex-1">
                    <label for="year-select" class="block text-sm font-medium text-slate-300">Year</label>
                    <select id="year-select" class="year-select mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-center">
                <div>
                    <h3 class="text-sm font-semibold text-slate-400">Total Sales</h3>
                    <p id="monthly-sales" class="text-lg font-bold text-blue-400">₹0.00</p>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-slate-400">Total Costs</h3>
                    <p id="monthly-costs" class="text-lg font-bold text-red-400">₹0.00</p>
                </div>
                <div>
                    <h3 class="text-sm font-semibold text-slate-400">Received Profit</h3>
                    <p id="monthly-profit" class="text-lg font-bold text-green-400">₹0.00</p>
                </div>
                 <div>
                    <h3 class="text-sm font-semibold text-slate-400">Pending Profit</h3>
                    <p id="monthly-pending" class="text-lg font-bold text-yellow-400">₹0.00</p>
                </div>
            </div>
        </div>

        <!-- Install Button -->
        <div id="install-container" class="text-center mb-6" style="display: none;">
            <button id="install-button" class="bg-purple-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-purple-600 transition-colors duration-200">
                Install App
            </button>
        </div>

        <!-- Order List -->
        <div>
            <div class="flex items-center justify-between mb-4">
                 <h2 class="text-xl font-bold">Order History</h2>
                 <div id="filter-container" class="flex border border-slate-600 rounded-lg p-0.5 bg-slate-700 no-print">
                    <button data-filter="all" class="filter-btn active-filter text-sm px-3 py-1 rounded-md">All</button>
                    <button data-filter="pending" class="filter-btn text-sm px-3 py-1 rounded-md">Pending</button>
                    <button data-filter="received" class="filter-btn text-sm px-3 py-1 rounded-md">Received</button>
                    <button data-filter="archived" class="filter-btn text-sm px-3 py-1 rounded-md">Archived</button>
                 </div>
            </div>
            <div id="order-list" class="space-y-3">
                <p id="no-orders" class="text-center text-slate-400 py-8">No orders yet. Add one to get started!</p>
            </div>
        </div>
    </div>

    <!-- Action Modal -->
    <div id="action-modal" class="modal-backdrop no-print">
        <div class="modal-content">
            <h3 id="modal-title" class="text-lg text-center font-bold mb-4"></h3>
            <div id="modal-body"></div>
            <div id="modal-footer" class="flex justify-center gap-4 mt-6"></div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, updateDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- App State & Elements ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "AIza...", authDomain: "...", projectId: "..."};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'rr-creations-app';
        const { jsPDF } = window.jspdf;

        let db, auth, userId = null, ordersCollection;
        let allOrders = []; // Local cache of all orders
        let itemToModifyId = null;
        let currentModifyAction = null;
        let currentFilter = 'all'; 

        const orderForm = document.getElementById('order-form');
        const customerNameInput = document.getElementById('customer-name');
        const itemDescriptionInput = document.getElementById('item-description');
        const vendorNameInput = document.getElementById('vendor-name');
        const costPriceInput = document.getElementById('cost-price');
        const sellingPriceInput = document.getElementById('selling-price');
        const paymentMethodInput = document.getElementById('payment-method');
        const orderList = document.getElementById('order-list');
        const totalPendingEl = document.getElementById('total-pending');
        const totalReceivedEl = document.getElementById('total-received');
        const noOrdersEl = document.getElementById('no-orders');
        const monthSelect = document.getElementById('month-select');
        const yearSelect = document.getElementById('year-select');
        const monthlySalesEl = document.getElementById('monthly-sales');
        const monthlyCostsEl = document.getElementById('monthly-costs');
        const monthlyProfitEl = document.getElementById('monthly-profit');
        const monthlyPendingEl = document.getElementById('monthly-pending');
        
        const actionModal = document.getElementById('action-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalFooter = document.getElementById('modal-footer');

        const notificationBtn = document.getElementById('notification-btn');
        const filterContainer = document.getElementById('filter-container');
        const exportPdfBtn = document.getElementById('export-pdf');
        const shareReportBtn = document.getElementById('share-report');
        const printDateEl = document.getElementById('print-date');
        const printTitleEl = document.getElementById('print-title');

        // --- Helper Functions ---
        const formatCurrency = (num) => {
            if (typeof num !== 'number') num = 0;
            return num.toLocaleString('en-IN', {
                style: 'currency',
                currency: 'INR',
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        // --- Firebase Initialization ---
        async function initFirebase() {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            setLogLevel('debug');

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    setupAppForUser();
                } else {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(auth);
                        }
                    } catch (error) {
                        console.error("Error signing in:", error);
                    }
                }
            });
        }

        function setupAppForUser() {
            if (!userId) return;
            const collectionPath = `artifacts/${appId}/users/${userId}/orders`;
            ordersCollection = collection(db, collectionPath);
            
            onSnapshot(ordersCollection, (snapshot) => {
                const fetchedOrders = [];
                snapshot.forEach((doc) => {
                    fetchedOrders.push({ id: doc.id, ...doc.data() });
                });
                fetchedOrders.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                allOrders = fetchedOrders; 
                
                const recapContainer = document.getElementById('recap-container');
                const now = new Date();
                if (recapContainer) {
                    const selectedMonth = monthSelect.value ? parseInt(monthSelect.value) : now.getMonth();
                    const selectedYear = yearSelect.value ? parseInt(yearSelect.value) : now.getFullYear();
                    setupDateSelectors(recapContainer, selectedMonth, selectedYear);
                    monthSelect.value = selectedMonth;
                    yearSelect.value = selectedYear;
                }

                renderOrders(); 
                updateTotals();
                calculateMonthlyRecap();
            });
        }

        // --- Core Functions ---
        const addOrder = async (e) => {
            e.preventDefault();
            const customerName = customerNameInput.value.trim();
            const itemDescription = itemDescriptionInput.value.trim();
            const vendorName = vendorNameInput.value.trim();
            
            const costPriceValue = costPriceInput.value.replace(/,/g, '');
            const sellingPriceValue = sellingPriceInput.value.replace(/,/g, '');

            const costPrice = parseFloat(costPriceValue);
            const sellingPrice = parseFloat(sellingPriceValue);
            const paymentMethod = paymentMethodInput.value;

            // --- Improved Validation ---
            if (!customerName || !itemDescription) {
                showMessageModal('Missing Information', 'Please enter both a customer name and an item description.');
                return;
            }
            if (isNaN(costPrice) || isNaN(sellingPrice) || costPrice < 0 || sellingPrice < 0) {
                showMessageModal('Invalid Price', 'Please enter valid numbers for the cost and selling price.');
                return;
            }
            if (sellingPrice < costPrice) {
                showMessageModal('Invalid Pricing', 'The selling price cannot be less than the cost price.');
                return;
            }
            if (!ordersCollection) {
                showMessageModal('Connection Error', 'Cannot save the order. Please check your connection and try again.');
                return;
            }

            const profit = sellingPrice - costPrice;
            try {
                await addDoc(ordersCollection, {
                    customerName,
                    itemDescription,
                    vendorName,
                    costPrice,
                    sellingPrice,
                    profit,
                    paymentMethod,
                    status: 'pending',
                    createdAt: new Date(),
                    isArchived: false
                });
                orderForm.reset();
            } catch (error) {
                console.error("Error adding order: ", error);
                showMessageModal('Save Error', 'Could not save the order. Please try again.');
            }
        };
        
        const updateStatus = async (id, newStatus) => {
            const orderDoc = doc(db, `artifacts/${appId}/users/${userId}/orders`, id);
            await updateDoc(orderDoc, { status: newStatus });
        };

        const archiveOrder = async (id) => {
            const orderDoc = doc(db, `artifacts/${appId}/users/${userId}/orders`, id);
            await updateDoc(orderDoc, { isArchived: true });
        };
        
        const unarchiveOrder = async (id) => {
            const orderDoc = doc(db, `artifacts/${appId}/users/${userId}/orders`, id);
            await updateDoc(orderDoc, { isArchived: false });
        };

        const deleteOrder = async (id) => {
            const orderDoc = doc(db, `artifacts/${appId}/users/${userId}/orders`, id);
            await deleteDoc(orderDoc);
        };
        
        // --- Modal Functions ---
        const hideActionModal = () => {
            actionModal.style.display = 'none';
            modalBody.innerHTML = '';
            modalFooter.innerHTML = '';
        };

        const showConfirmationModal = (id, action) => {
            itemToModifyId = id;
            currentModifyAction = action;

            let title, text, confirmText, confirmClass;
            if (action === 'archive') {
                title = 'Confirm Archive';
                text = 'Are you sure you want to archive this order? You can view it later in the "Archived" section.';
                confirmText = 'Archive';
                confirmClass = 'bg-slate-500 text-white hover:bg-slate-600';
            } else if (action === 'delete') {
                title = 'Confirm Deletion';
                text = 'Are you sure you want to permanently delete this order? This action cannot be undone.';
                confirmText = 'Delete';
                confirmClass = 'bg-red-600 text-white hover:bg-red-700';
            }

            modalTitle.textContent = title;
            modalBody.innerHTML = `<p class="text-slate-300 text-center">${text}</p>`;
            modalFooter.innerHTML = `
                <button id="confirm-btn" class="${confirmClass} font-semibold py-2 px-6 rounded-lg">${confirmText}</button>
                <button id="cancel-btn" class="bg-slate-600 text-slate-200 font-semibold py-2 px-6 rounded-lg hover:bg-slate-500">Cancel</button>
            `;

            document.getElementById('confirm-btn').onclick = handleConfirm;
            document.getElementById('cancel-btn').onclick = hideActionModal;
            actionModal.style.display = 'flex';
        };

        const showMessageModal = (title, text) => {
            modalTitle.textContent = title;
            modalBody.innerHTML = `<p class="text-slate-300 text-center">${text}</p>`;
            modalFooter.innerHTML = `<button id="ok-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">OK</button>`;
            
            document.getElementById('ok-btn').onclick = hideActionModal;
            actionModal.style.display = 'flex';
        }

        const handleConfirm = async () => {
            if (!itemToModifyId || !currentModifyAction) return;
            try {
                if (currentModifyAction === 'archive') {
                    await archiveOrder(itemToModifyId);
                } else if (currentModifyAction === 'delete') {
                    await deleteOrder(itemToModifyId);
                }
            } catch (error) {
                console.error(`Error performing action '${currentModifyAction}':`, error);
            } finally {
                hideActionModal();
            }
        };
        
        const calculateMonthlyRecap = () => {
            const selectedMonth = parseInt(monthSelect.value);
            const selectedYear = parseInt(yearSelect.value);

            const filteredOrders = allOrders.filter(order => {
                if (order.isArchived || !order.createdAt || !order.createdAt.seconds) return false;
                const orderDate = new Date(order.createdAt.seconds * 1000);
                return orderDate.getMonth() === selectedMonth && orderDate.getFullYear() === selectedYear;
            });
            
            const sales = filteredOrders.reduce((sum, o) => sum + o.sellingPrice, 0);
            const costs = filteredOrders.reduce((sum, o) => sum + o.costPrice, 0);
            const receivedProfit = filteredOrders.filter(o => o.status === 'received').reduce((sum, o) => sum + o.profit, 0);
            const pendingProfit = filteredOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);

            monthlySalesEl.textContent = formatCurrency(sales);
            monthlyCostsEl.textContent = formatCurrency(costs);
            monthlyProfitEl.textContent = formatCurrency(receivedProfit);
            monthlyPendingEl.textContent = formatCurrency(pendingProfit);
        };

        // --- UI Rendering ---
        const renderOrders = () => {
            orderList.innerHTML = '';
            
            const filteredOrders = allOrders.filter(order => {
                if (currentFilter === 'archived') {
                    return order.isArchived;
                }
                if (order.isArchived) return false;
                if (currentFilter === 'all') return true;
                return order.status === currentFilter;
            });

            noOrdersEl.style.display = filteredOrders.length === 0 ? 'block' : 'none';
            if (filteredOrders.length === 0 && allOrders.length > 0) {
                 noOrdersEl.textContent = `No orders match the "${currentFilter}" filter.`;
            } else if (allOrders.length === 0) {
                 noOrdersEl.textContent = 'No orders yet. Add one to get started!';
            }
            
            filteredOrders.forEach(order => {
                const isPending = order.status === 'pending';
                const cardClass = isPending ? 'status-pending' : 'status-received';
                const statusTextClass = isPending ? 'text-status-pending' : 'text-status-received';

                const orderEl = document.createElement('div');
                orderEl.className = `p-4 rounded-lg shadow-md flex flex-col sm:flex-row sm:items-start sm:justify-between gap-4 ${cardClass} dark:border order-card`;
                orderEl.innerHTML = `
                    <div class="flex-grow">
                        <p class="font-semibold text-slate-100">${order.customerName}</p>
                        <p class="text-sm text-slate-400">${order.itemDescription}</p>
                        ${order.vendorName ? `<p class="text-xs text-slate-400 mt-1">Sold by: <span class="font-medium">${order.vendorName}</span></p>` : ''}
                        <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm mt-2">
                           <p><span class="font-medium text-slate-400">Sale:</span> ${formatCurrency(order.sellingPrice)}</p>
                           <p><span class="font-medium text-slate-400">Cost:</span> ${formatCurrency(order.costPrice)}</p>
                           <p><span class="font-bold text-green-400">Profit:</span> ${formatCurrency(order.profit)}</p>
                           ${order.paymentMethod ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${order.paymentMethod === 'GPay' ? 'bg-blue-900 text-blue-200' : 'bg-emerald-900 text-emerald-200'}">${order.paymentMethod}</span>` : ''}
                        </div>
                    </div>
                    <div class="flex flex-col sm:items-end gap-2 w-full sm:w-auto flex-shrink-0 order-actions">
                         ${order.isArchived ? `<span class="font-bold text-sm uppercase text-slate-400">Archived</span>` : `<span class="font-bold text-sm uppercase ${statusTextClass}">Profit ${order.status}</span>`}
                         <div class="flex items-center gap-2 w-full sm:w-auto">
                            ${order.isArchived ? 
                                `<button data-id="${order.id}" data-action="unarchive" class="bg-sky-500 text-white flex-grow sm:flex-grow-0 text-sm font-semibold py-2 px-3 rounded-md transition-transform transform hover:scale-105">Unarchive</button>
                                 <button data-id="${order.id}" data-action="delete" class="bg-red-500 text-white p-2 rounded-md hover:bg-red-600 transition-transform transform hover:scale-105" title="Delete Permanently">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
                                 </button>`
                            :
                            isPending ? 
                            `<button data-id="${order.id}" data-action="receive" class="btn-received flex-grow sm:flex-grow-0 text-sm font-semibold py-2 px-3 rounded-md transition-transform transform hover:scale-105">Received</button>` : 
                            `<button data-id="${order.id}" data-action="pend" class="btn-pending flex-grow sm:flex-grow-0 text-sm font-semibold py-2 px-3 rounded-md transition-transform transform hover:scale-105">Pending</button>`
                            }
                            ${!order.isArchived ? `<button data-id="${order.id}" data-action="archive" class="bg-slate-400 text-white p-2 rounded-md hover:bg-slate-500 transition-transform transform hover:scale-105" title="Archive">
                                 <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 8v13H3V8"></path><path d="M1 3h22v5H1z"></path><path d="M10 12h4"></path></svg>
                            </button>` : ''}
                        </div>
                    </div>
                `;
                orderList.appendChild(orderEl);
            });
        };

        const updateTotals = () => {
            const activeOrders = allOrders.filter(o => !o.isArchived);
            const pendingProfit = activeOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);
            const receivedProfit = activeOrders.filter(o => o.status === 'received').reduce((sum, o) => sum + o.profit, 0);

            totalPendingEl.textContent = formatCurrency(pendingProfit);
            totalReceivedEl.textContent = formatCurrency(receivedProfit);
        };
        
        function setupDateSelectors(container, currentMonth, currentYear) {
            const months = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            
            const monthSelectEl = container.querySelector('.month-select');
            const yearSelectEl = container.querySelector('.year-select');

            if (!monthSelectEl || !yearSelectEl) {
                console.error("Could not find month or year select elements in the provided container.", container);
                return;
            }

            monthSelectEl.innerHTML = '';
            yearSelectEl.innerHTML = '';

            months.forEach((month, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = month;
                if (index === currentMonth) option.selected = true;
                monthSelectEl.appendChild(option);
            });
            
            const uniqueYears = [...new Set(allOrders.map(o => o.createdAt ? new Date(o.createdAt.seconds * 1000).getFullYear() : currentYear))];
            if (!uniqueYears.includes(currentYear)) uniqueYears.push(currentYear);
            uniqueYears.sort((a,b) => b - a);

            uniqueYears.forEach(year => {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                if (year === currentYear) option.selected = true;
                yearSelectEl.appendChild(option);
            });
        }

        // --- Notification Logic ---
        function updateNotificationBellUI() {
            const bellSVG = notificationBtn.querySelector('svg');
            if (!('Notification' in window)) {
                bellSVG.style.stroke = '#9ca3af'; // gray-400
                notificationBtn.style.opacity = '0.5';
                notificationBtn.style.cursor = 'not-allowed';
                return;
            }

            switch(Notification.permission) {
                case "granted":
                    bellSVG.style.stroke = '#16a34a'; // green-600
                    break;
                case "denied":
                    bellSVG.style.stroke = '#ef4444'; // red-500
                    notificationBtn.style.opacity = '0.6';
                    notificationBtn.style.cursor = 'not-allowed';
                    break;
                default:
                    bellSVG.style.stroke = 'currentColor'; // default
            }
        }

        function setupReminder() {
            updateNotificationBellUI();

            if (!('Notification' in window) || Notification.permission === "denied") return;
            if (Notification.permission === "granted") setInterval(checkTimeForReminder, 60 * 1000);

            notificationBtn.addEventListener('click', () => {
                if (Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        updateNotificationBellUI();
                        if (permission === "granted") setInterval(checkTimeForReminder, 60 * 1000);
                    });
                }
            });
        }

        function checkTimeForReminder() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const lastNotificationDate = localStorage.getItem('lastNotificationDate');
            
            if (now.getHours() >= 23 && lastNotificationDate !== todayStr) {
                const activeOrders = allOrders.filter(o => !o.isArchived);
                const totalPending = activeOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);
                
                if (totalPending > 0) {
                     const title = 'Daily Profit Reminder';
                     const options = {
                        body: `You have ${formatCurrency(totalPending)} in pending profit. Don't forget to follow up!`,
                        icon: 'https://placehold.co/192x192/4f46e5/ffffff?text=RR',
                        tag: 'profit-reminder', 
                        renotify: true,
                     };
                     new Notification(title, options);
                     localStorage.setItem('lastNotificationDate', todayStr);
                }
            }
        }
        
        // --- Share & Export ---
        const handleShareClick = () => {
            modalTitle.textContent = 'Generate & Share Report';
            modalBody.innerHTML = `
                <p class="text-slate-300 text-center mb-4">Select the month and year for the report you want to share.</p>
                <div class="flex gap-4">
                    <div class="flex-1">
                        <label for="share-month-select" class="block text-sm font-medium text-slate-300">Month</label>
                        <select id="share-month-select" class="month-select mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                    </div>
                    <div class="flex-1">
                        <label for="share-year-select" class="block text-sm font-medium text-slate-300">Year</label>
                        <select id="share-year-select" class="year-select mt-1 block w-full px-3 py-2 bg-slate-700 border border-slate-600 rounded-md text-sm shadow-sm focus:outline-none focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 text-white"></select>
                    </div>
                </div>`;
            
            const now = new Date();
            setupDateSelectors(modalBody, now.getMonth(), now.getFullYear());

            modalFooter.innerHTML = `
                <button id="generate-share-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700">Generate & Share PDF</button>
            `;

            document.getElementById('generate-share-btn').onclick = generateAndSharePdf;
            actionModal.style.display = 'flex';
        };

        const generateAndSharePdf = async () => {
            const shareMonthSelect = document.getElementById('share-month-select');
            const shareYearSelect = document.getElementById('share-year-select');
            
            const month = parseInt(shareMonthSelect.value);
            const year = parseInt(shareYearSelect.value);
            const monthName = shareMonthSelect.options[shareMonthSelect.selectedIndex].text;
            
            hideActionModal();
            showMessageModal('Generating PDF...', 'Please wait while your report is being created. The share dialog will appear shortly.');
            
            const doc = new jsPDF();
            
            const filteredOrders = allOrders.filter(order => {
                if (order.isArchived || !order.createdAt || !order.createdAt.seconds) return false;
                const orderDate = new Date(order.createdAt.seconds * 1000);
                return orderDate.getMonth() === month && orderDate.getFullYear() === year;
            });

            if (filteredOrders.length === 0) {
                 showMessageModal('No Data', `There are no orders for ${monthName} ${year} to generate a report.`);
                 return;
            }

            const head = [['Date', 'Customer', 'Item', 'Vendor', 'Cost', 'Sale', 'Profit', 'Status']];
            const body = filteredOrders.map(o => [
                new Date(o.createdAt.seconds * 1000).toLocaleDateString(),
                o.customerName,
                o.itemDescription,
                o.vendorName || '-',
                formatCurrency(o.costPrice),
                formatCurrency(o.sellingPrice),
                formatCurrency(o.profit),
                o.status
            ]);
            
            const sales = filteredOrders.reduce((sum, o) => sum + o.sellingPrice, 0);
            const costs = filteredOrders.reduce((sum, o) => sum + o.costPrice, 0);
            const receivedProfit = filteredOrders.filter(o => o.status === 'received').reduce((sum, o) => sum + o.profit, 0);
            const pendingProfit = filteredOrders.filter(o => o.status === 'pending').reduce((sum, o) => sum + o.profit, 0);
            
            doc.setFontSize(18);
            doc.text(`RR Creations - Report for ${monthName} ${year}`, 14, 20);
            doc.setFontSize(11);
            doc.setTextColor(100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 14, 26);
            
            doc.autoTable({
                startY: 30,
                head: head,
                body: body,
                theme: 'striped',
                headStyles: { fillColor: [79, 70, 229] }
            });
            
            const summaryY = doc.autoTable.previous.finalY + 10;
            doc.setFontSize(12);
            doc.text('Monthly Summary', 14, summaryY);
            doc.autoTable({
                startY: summaryY + 4,
                body: [
                    ['Total Sales', formatCurrency(sales)],
                    ['Total Costs', formatCurrency(costs)],
                    ['Pending Profit', formatCurrency(pendingProfit)],
                    ['Received Profit', formatCurrency(receivedProfit)],
                ],
                theme: 'grid',
                columnStyles: { 0: { fontStyle: 'bold' } }
            });

            const pdfBlob = doc.output('blob');
            const fileName = `RR_Creations_Report_${monthName}_${year}.pdf`;
            const pdfFile = new File([pdfBlob], fileName, { type: 'application/pdf' });

            if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
                try {
                    await navigator.share({
                        title: `RR Creations Report for ${monthName} ${year}`,
                        text: `Here is the monthly report for ${monthName} ${year}.`,
                        files: [pdfFile]
                    });
                    hideActionModal();
                } catch (error) {
                    console.error('Share failed:', error);
                    showMessageModal('Share Failed', 'There was an error trying to share the file. Please try exporting instead.');
                }
            } else {
                showMessageModal('Share Not Supported', 'Your browser does not support sharing files. Please use the "Export PDF" button to download the report.');
            }
        };

        // --- Event Listeners ---
        orderForm.addEventListener('submit', addOrder);
        orderList.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            const { id, action } = button.dataset;
            if (action === 'receive') updateStatus(id, 'received');
            else if (action === 'pend') updateStatus(id, 'pending');
            else if (action === 'archive') showConfirmationModal(id, 'archive');
            else if (action === 'delete') showConfirmationModal(id, 'delete');
            else if (action === 'unarchive') unarchiveOrder(id);
        });

        filterContainer.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (!button) return;
            currentFilter = button.dataset.filter;
            filterContainer.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active-filter'));
            button.classList.add('active-filter');
            renderOrders();
        });
        
        monthSelect.addEventListener('change', calculateMonthlyRecap);
        yearSelect.addEventListener('change', calculateMonthlyRecap);
        actionModal.addEventListener('click', (e) => {
            if (e.target === actionModal) hideActionModal();
        });

        exportPdfBtn.addEventListener('click', () => {
            const selectedMonth = monthSelect.options[monthSelect.selectedIndex].text;
            const selectedYear = yearSelect.value;
            printTitleEl.textContent = `RR Creations - ${selectedMonth} ${selectedYear} Report`;
            printDateEl.textContent = `Generated on: ${new Date().toLocaleDateString()}`;
            window.print();
        });
        shareReportBtn.addEventListener('click', handleShareClick);


        // --- PWA Install Logic ---
        let deferredPrompt;
        const installContainer = document.getElementById('install-container');
        const installButton = document.getElementById('install-button');
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            installContainer.style.display = 'block';
        });
        installButton.addEventListener('click', async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                await deferredPrompt.userChoice;
                deferredPrompt = null;
                installContainer.style.display = 'none';
            }
        });
        
        // --- App Initialization ---
        const now = new Date();
        const recapContainer = document.getElementById('recap-container');
        if (recapContainer) {
            setupDateSelectors(recapContainer, now.getMonth(), now.getFullYear());
        }
        
        initFirebase();
        setupReminder();
    </script>
</body>
</html>
"

